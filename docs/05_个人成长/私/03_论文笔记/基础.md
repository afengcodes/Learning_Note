参考 [智能网联汽车协同决策与规划技术](https://blog.csdn.net/mpt0816/category_11473928.html)

#
## 一
### 1. 单车在低速非结构化场景中的规划

在非结构化场景中，汽车**行驶速度不高**，此时车辆运动学属性和带有Ackerman转向的轮式机器人相似，因此相应的规划方法的发展主要源于机器人学科。与高速结构化道路场景相比，低速非结构化场景以泊车场景为典型代表，往往体现出**杂乱、狭窄**的特点，且**场景中障碍物的运动模态难以准确跟踪或者预测**。此外，在低速非结构化场景中，车辆还可以**倒退**，也导致了该场景的规划方法较之结构化道路上更加复杂。

适用的成熟的规划方法方法可以分为采用搜索(sample-and-search-based)方法以及最优控制(optimal control-based)方法两大类。

采样搜索方法按照采用方式分为状态空间采样和控制空间采样。状态空间采样以A *和state-lattice，以及在两者基础上发展的采样搜索方法。在车辆规划问题中，控制空间的维度远低于状态空间，因此在控制空间采样搜索的计算效率高，也天然具有符合车辆运动学的优势，典型的控制空间采用方法有动态窗口法(Dynamic Window Approach,DWA)和hybrid A *。

最优控制方法特色是基于连续变量来搭建规划问题模型，因此能够更加直观、精细、统一的描述规划任务。用于描述车辆规划任务的最优控制问题由代价函数和约束条件组成，其中约束条件主要放映车辆的运动能力、规划任务的始末运动状态以及避障限制条件，代价函数是筛选优化规划结果的依据，体现对于行车过程节能性、舒适性和可靠性的追求，对最优控制问题模型进行求解即可得到车辆运动轨迹\路径。

数值求解最优控制问题的方式是将最优控制问题首先依自自变量进行离散化，从而将最优控制问题转化为非线性规划(Nonlinear Programming, NLP)问题。NLP问题继承了原始最优控制问题的难点，即问题自由度低(如控制变量只包括车速和车轮转角)，但状态量众多，且碰撞躲避约束条件具有高纬度、强非线性(非凸甚至局部不可微)的特点。

常见的NLP问题解法分为严格约束法以及软约束法。严格约束方法旨在求解能够严格满足NLP问题中全部约束条件的解，常用的方法包括**序贯二次规划**(Sequence Quadratic Programing， SQP)方法和**内点法**(Interior-Point Method, IPM)。软约束方法将复杂的约束条件转化为外罚函数补入代价函数，从而构成一个至多只包含简单边界约束的非线性优化问题。由于软约束中不存在硬性约束条件，可能存在碰撞风险。**共轭梯度(Conjugate Gradient，CG)**和**时变弹性带(Timed Elastic Band，TEB)**是典型的软约束方法。

NLP问题一般都仅有局部寻优能力，可能会收敛到某个局部最优解。为了保障NLP问题的求解质量，一种自然的方法是借用全局“视野”的算法快速生成粗糙的初始解，并从该初始解的领域开展局部优化。即便有优质的初始解，NLP问题所具有的规模大、非线性强属性依然存在，需要降低NLP问题的复杂程度，更准确的讲，降低碰撞躲避相关的约束条件的处理。局部隧道化建模策略是一种典型方法，在初始解的邻域内构建一条“隧道”来彻底的将车身与周边的障碍物隔离，从而将复杂的碰撞躲避约束彻底替换为规模及非线性程度皆可掌控的“车辆必须行驶在隧道中”的约束。

在低速非结构化场景中多数进行路径规划，速度规划的任务转移到了闭环控制模块中。

### 2. 单车在结构化道路场景中的规划

与非结构化低速场景相比，结构化道路场景与之有显著不同。从环境中移动物体来讲，众多非协作社会车辆的行驶行为虽然**具有一定可预测性**，但其固有的未知性给规划带来不小的挑战，甚至需要规划以最坏的情况来看待周围态势。从车辆运动学模型来说，结构化道路一般会设计的走势平缓，导致车辆一般不会触及极限运动能力，可以使用非常简单的方法建模描述车辆的运动能力。从时效性来讲，结构化道路中车速普遍较高，为留出安全时间裕度，一般要求规划方法在几十毫秒内完成一次完整计算。

面向结构化道路的轨迹规划几乎都属于复合方法，常见的技术特征包括坐标系简化、轨迹解耦、采样、搜索及优化。

文章《Optimal Trajectory Generation for Dynamic Street Scenarios in a Frenet Frame》首次将Frenet坐标系概念应用到结构化道路上的轨迹规划；
文章《A Real-Time Motion Planner with Trajectory Optimization for Autonomous Vehicles》中的交替优化的想法启发了百度的Apollo EM算法；
文章《Motion planning for autonomous driving with a conformal spatiotemporal lattice》认为路径速度解耦会损失轨迹的最优性，将时间视为状态变量、基于多项式方法采样一系列时空轨迹(spatiotemporal lattice)并构造连通图，随后通过动态规划实现搜索，从而到达一次性规划轨迹的目的。


3.多车在低速非结构化场景中的协同规划

低速非结构化场景中的多车协同轨迹规划任务与现阶段自动驾驶研发初期目标相距较远，相关文献不多。现有方法分为集中式(centralized)方法和解耦式(decoupled)方法。集中式方法的核心特点是完整描述规划问题，并要求一次性求解所有车辆的行驶轨迹。解耦式方法是将完整而复杂的原始问题经过一种或者多种解耦处理，从而将原始的多车协同问题转化为一系列简单问题来分别解决。

4.多车在结构化道路场景中的协同规划

在结构化道路上，适合开展多车协同规划的场景主要包括路段上的换道任务、汇入车流任务、以及无信号灯路口通行任务，这些道路环境中的多车协同规划任务的本质是协调各车辆运动轨迹之间的潜在冲突。名义上讲，多车协同轨迹规划问题是一个高纬度的最优控制问题，将整个车辆编队视为一个大系统，将协同规划任务视为针对这一大系统的两点边值控制问题，而这个大系统的空间形态是分散的，状态也由各车辆运动状态组合而成。

一般的决策规划是指行为决策(behavior)和运动规划(motion planning)，行为决策多是离散型决定。从此书的综述来看，此书着重使用最优控制的方法解决运动规划(motion planning)问题。


## 
本章介绍在低速非结构化场景中的最优化规划问题的构建和决策规划的计算流程。作者着重介绍了最优控制问题的一般形式和数值求解方法，以及使用A*求解初始值。

最优化问题为连续Bolza型问题，通过离散化通过非线性求解器计算。由于初始解既可以提高非线性规划问题的求解效率，又可以避免非线性规划限于局部最优解，因此先使用全局规划方法得到粗糙的轨迹作为决策轨迹，并作为非线性规划的初始解，非线性规划的结果最为最终规划的轨迹。

1. 轨迹规划命题的构建
车辆的轨迹规划任务是指在车辆的起始运动状态与终止时刻运动状态之间计算出满足符合约束调节的行驶轨迹，其中约束条件主要包括车辆内在的运动能力限制以及与外部环境相关的碰撞躲避限制。另一方面，满足上述约束条件的轨迹往往不止一条，应通过某一指标筛选优质的轨迹作为最终结果。鉴于轨迹规划任务存在硬约束条件以及用于寻优的指标式，因此适合采用最优控制问题的形式来描述。采用Bolza型最优控制问题形式。

其中，约束条件有：

系统动态方程约束；
两点边值约束；
流形约束(状态变量约束、控制变量约束、碰撞躲避约束)；
比如在泊车轨迹规划中，对终止时刻的车辆姿态角的边界值约束要格外慎重的设置。如果明确要求车辆在终止时刻到达某一既定姿态角

在自动驾驶轨迹规划具体任务中，NLP问题的初始化是NLP求解的重要前置环节，将优质初始解的估算定义为轨迹决策。

2. 决策轨迹的生成
轨迹决策负责对场景所有的运动或者静止障碍物提供绕行方式的决策，其输出是一条衔接起点和终点的粗糙轨迹。路径信息反应了车辆在哪一侧绕行静态障碍物，沿路径行驶的时间信息决定以何种速度沿着该路径行驶，不同的时间戳布置可以造成针对移动障碍物的减速让行或者加速超车决策。除了一次生成粗略轨迹外，工程中也会解耦为路径决策+速度决策两个步骤。分开决策可以更直观、更有针对性地实现对车辆决策规划的调控，但会损害决策结果的最优性。

2.1 基于X-Y空间的搜索
在使用仅具备局部寻优能力的主流优化器求解轨迹规划问题时，最终收敛到的局部最优解与初始解保持同伦关系，因此初始解决定优化器是否可以收敛的全局最优解。因此具有全局优化搜索能力的A*算法可以被用来计算初始解。

此外，混合A*算法在离散x − y − θ x-y-\thetax−y−θ状态空间中使用A*策略并融合Reeds-Shepp曲线，与A*相比有以下差异：





其他：
1　混合A星的思想

　　混合A星算法是2008年斯坦福的Dmitri Dolgov, Sebastian Thrun等人在论文《Practical Search Techniques in Path Planning for Autonomous Driving》中首次提出的，后来又补充了一些细节发表在顶级期刊International Journal of Robotics Reaserch上。狭义的混合A星只包含搜索的过程，广义的混合A星把后处理也加上了。所以混合A星可以看成是由几个模块组合起来的。路径规划的三大门派：图搜索法、随机采样法、势场法全部在这篇文章中现身了。
　　混合A星可以看成是探索树方法和A星算法的混血，这两种方法在机器人领域都是大名鼎鼎，所以结个婚生个孩子也很正常，毕竟组合创新是最容易的创新之一。就连Matlab居然都内置了混合A星算法：plannerHybridAStar，可见这个算法也出名了，但是Matlab使用了占据栅格地图进行碰撞检测。混合A星适合有运动约束的机器人，最典型的就是汽车。
　　混合A星算法的思想比较简单，为了让入门者更容易理解，我先介绍它的爸爸妈妈：探索树方法和A星算法。探索树方法也是一个比较通用的方法，有好多变种，最有名的就是RRT（快速探索随机树）方法，如下面的左图所示。
　　A星算法也是非常有名，它其实也是生长一颗树，从起点开始不断向外探索，直到找到目标点停止生长。这么描述听起来好像跟Dijkstra方法一样，只不过A星方法更“聪明”。Dijkstra方法比较笨，它只知道傻傻地一个个生长最外面的所有节点。A星就知道哪些节点离目标更近，它会优先生长更近的节点，所以A星比Dijkstra方法快。

1.1　启发信息

　　启发信息（heuristics）对于混合A星算法至关重要，也是作者着重讨论的。混合A星算法使用了两种启发信息的组合，这两种启发一种“考虑运动约束不考虑障碍物”，一种刚好相反“不考虑运动约束考虑障碍物”，如下图所示。这个“考虑约束不考虑障碍物”的启发就是Reeds-Shepp曲线的长度，“不考虑约束考虑障碍物”的启发就是传统A星算法搜索到目标的路径的长度。混合A星算法选择两者的最大值作为最终的启发信息。


　　启发信息唯一的作用是给搜索算法提供指引、让算法更“聪明”，从而优先探索有可能产生解的区域，不要在没必要的区域浪费时间。因为我们的探索过程计算量可能比较大，所以启发信息提供的指导越准确，最终算法的效率就越高。启发信息既然只是提供指导，那么它的计算量就不能太大，最好是很快就能算出来的，例如A星使用的到目标的欧式距离，混合A星使用的Reeds-Shepp曲线的长度和A星的结果不是非常快（跟欧式距离比），但是还是可以接受的。作者也发现了，Reeds-Shepp曲线这一启发信息既然不依赖障碍物，那就可以提前把所有离散节点的长度一次性都算出了，然后用的时候直接查询，用空间换时间的方法显然就快多了。对启发信息的一个要求是，不能高估，可以低估。这里采用的两个启发信息都是低估，所以是合理的，最终取最大值当然也是低估。
　　作者还表示，这么定义的启发信息跟混合A星算法其实没什么关系（不依赖混合A星的状态）。也就是说，你可以用在其它搜索算法上（随便用不要钱），当然你要是有更牛逼的启发信息也可以把它换成你自己的。所以，启发信息是个可以替换的模块，跟混合A星算法不是绑定的，你觉得好就用，有更好的也可以换，当然你要是彻底不用那混合A星算法就发挥不出它的威力了。



4　混合A星算法实现

　　混合A星算法实现采用的是Github上 karlkurzer 的版本，下载和编译过程如下。新建并运行脚本即可实现傻瓜式一键安装，非常简单。